
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A service to manage, query and version VCF files and associated sample metadata">
      
      
      
        <link rel="canonical" href="https://scilifelabdatacentre.github.io/divbase/development/celery_task_implementation/">
      
      
        <link rel="prev" href="../database-migrations/">
      
      
        <link rel="next" href="../bcftools_task_logic/">
      
      
        
      
      
      <link rel="icon" href="../../assets/img/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Celery Task Implementation - DivBase</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
<meta property="og:type" content="website" />
<meta property="og:title" content="Celery Task Implementation - DivBase" />
<meta property="og:description" content="A service to manage, query and version VCF files and associated sample metadata" />
<meta property="og:image" content="https://scilifelabdatacentre.github.io/divbase/assets/images/social/development/celery_task_implementation.png" />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:url" content="https://scilifelabdatacentre.github.io/divbase/development/celery_task_implementation/" />
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:title" content="Celery Task Implementation - DivBase" />
<meta property="twitter:description" content="A service to manage, query and version VCF files and associated sample metadata" />
<meta property="twitter:image" content="https://scilifelabdatacentre.github.io/divbase/assets/images/social/development/celery_task_implementation.png" />
</head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#celery-task-implementation-in-divbase" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DivBase" class="md-header__button md-logo" aria-label="DivBase" data-md-component="logo">
      
  <img src="../../assets/img/scilifelab_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DivBase
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Celery Task Implementation
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2C5.13 2 2 5.13 2 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm13-8h-2l-3.2 9h1.9l.7-2h3.2l.7 2h1.9zm-2.15 5.65L18 15l1.15 3.65z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="light-green"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ScilifelabDataCentre/divbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    ScilifelabDataCentre/divbase
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  DivBase

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../user-guides/" class="md-tabs__link">
          
  
  
    
  
  User Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../cli/" class="md-tabs__link">
          
  
  
    
  
  CLI Command Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Developer Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="https://divbase.scilifelab.se" class="md-tabs__link">
        
  
  
    
  
  Go to DivBase Website

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DivBase" class="md-nav__button md-logo" aria-label="DivBase" data-md-component="logo">
      
  <img src="../../assets/img/scilifelab_logo.png" alt="logo">

    </a>
    DivBase
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ScilifelabDataCentre/divbase" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
  </div>
  <div class="md-source__repository">
    ScilifelabDataCentre/divbase
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    DivBase
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    DivBase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SECURITY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security Policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../user-guides/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    User Guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/account-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Account Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/setup_divbase_cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup DivBase CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/vcf-files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Working with VCF Files in DivBase
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Running Queries
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Running Queries
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/running-queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/sidecar-metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sidecar Metadata TSV files: creating and querying sample metadata files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/vcf-dimensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VCF Dimensions caching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/query-syntax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DivBase Query Syntax for VCF data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/how-to-create-efficient-divbase-queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to create efficient DivBase queries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/tutorial-query-on-public-data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial: Running a query on a public dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/project-versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Managing Project Versions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guides/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../cli/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    CLI Command Reference
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    CLI Command Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/divbase-cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli auth
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/query/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli query
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/version/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli version
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/dimensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli dimensions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/_auto_generated/task-history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    divbase-cli task-history
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Developer Guide
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developer Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../database-migrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Database Migrations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Celery Task Implementation
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Celery Task Implementation
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Table of Contents
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          1. Overview
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-implementation-of-user-submitted-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2. Implementation of user-submitted tasks
        </span>
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Implementation of user-submitted tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-task-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.1 Task Definition
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.2. Pydantic models
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-api-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.3. API endpoint
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.4. CLI
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-task-history-deserialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.5. Task History deserialization
        </span>
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-implementation-of-system-submitted-periodic-cron-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          3. Implementation of system-submitted periodic (cron) tasks
        </span>
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcftools_task_logic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bcftools Celery Task Logic
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bcftools_task_constraints/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bcftools Celery Task Constraints
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../task_history_implementation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Task History Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sending-emails/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sending Emails
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3_transfers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    S3 Transfers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring_and_observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring and observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../worker_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monitoring: Celery Worker Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://divbase.scilifelab.se" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Go to DivBase Website
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          Table of Contents
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          1. Overview
        </span>
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-implementation-of-user-submitted-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2. Implementation of user-submitted tasks
        </span>
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Implementation of user-submitted tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-task-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.1 Task Definition
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-pydantic-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.2. Pydantic models
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-api-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.3. API endpoint
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.4. CLI
        </span>
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-task-history-deserialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          2.5. Task History deserialization
        </span>
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-implementation-of-system-submitted-periodic-cron-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        <span class="md-typeset">
          3. Implementation of system-submitted periodic (cron) tasks
        </span>
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/ScilifelabDataCentre/divbase/edit/master/docs/development/celery_task_implementation.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/ScilifelabDataCentre/divbase/raw/master/docs/development/celery_task_implementation.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="celery-task-implementation-in-divbase">Celery task implementation in DivBase<a class="headerlink" href="#celery-task-implementation-in-divbase" title="Permanent link">&para;</a></h1>
<p>DivBase uses <a href="https://docs.celeryq.dev/">Celery</a> as an asynchronous job management system. This document aims to describe how Celery tasks are implemented in the DivBase system architechture. The document can serve as a guide for maintaining and updating existing tasks, as well as implementing new tasks. It is intended to be a complement to the official Celery documentation, so please refer to them in addition to this.</p>
<p>As a rule-of-thumb, Celery tasks are intended to be used for operations that have a runtime that is longer than what is suitable for an asynchronous database transaction. In practice, operations that require interacting with files in an S3 bucket (including parsing the content of the files) should be run as a Celery task. If you want to implement a new function in DivBase that <strong>only</strong> relies on calling a CRUD function, it is better to do this directly in the API endpoint rather than enqueing a Celery task with the same logic.</p>
<p>Tasks can be divided by how they are submitted to the queue: user-submitted tasks, and system-submitted periodic tasks. User-submitted tasks are manually enqueued in the job management system by entering a command on in the DivBase CLI. System-submitted periodic tasks are cronjobs that are enqueued based on a time schedule, and typically handle system maintenance tasks such as cleanup jobs.</p>
<p>Assuming that a task has been implemented as decribed in this document, DivBase users can access their task history with the <code>divbase-cli task-history</code> command. Please see <a href="../task_history_implementation/">Task History Implementation</a> for details on how the task history works.</p>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#1-overview">1. Overview</a></li>
<li><a href="#2-implementation-of-user-submitted-tasks">2. Implementation of user-submitted tasks</a></li>
<li><a href="#21-task-definition">2.1 Task Definition</a></li>
<li><a href="#22-pydantic-models">2.2. Pydantic models</a></li>
<li><a href="#23-api-endpoint">2.3. API endpoint</a></li>
<li><a href="#24-cli">2.4. CLI</a></li>
<li><a href="#25-task-history-deserialization">2.5. Task History deserialization</a></li>
<li><a href="#3-implementation-of-system-submitted-periodic-cron-tasks">3. Implementation of system-submitted periodic (cron) tasks</a></li>
</ul>
<h2 id="1-overview">1. Overview<a class="headerlink" href="#1-overview" title="Permanent link">&para;</a></h2>
<p>Tasks are generally executed asynchronously and can possibly take a bit of time to run. This means that queing tasks and fetching task results are treated as two separate processes with their own CLI commands*. For instance, a user might send a VCF file query task with the <code>divbase-cli query bcftools-pipe</code> CLI command; they can then run the <code>divbase-cli task-history user</code> command to learn the status of the job (queuing, started, sucess, failed) and any result or error messages. This document describes the steps needed to fully implement a task in Divbase, including  a CLI command to schedule the task, and the steps needed to make the task work with the task history command. Details on how the task history architechture works is not covered in this document.</p>
<p>* One exception is <code>sample_metadata_query_task</code> that is assumed to run so quickly that it waits for results to be returned back to the user's terminal. The task is enqueued as an asynchronous celery task like any other task, with the difference that the API layer waits for the task layer to return the results so that the API in turn can return that to the users terminal.</p>
<p>DivBase uses a layered architechture and therefore task implementations occur at several layers. Roughly speaking, there is a Celery worker layer where the Celery app and its tasks are defined (including task metadata writes to database), an API layer that handles routing and some other required database operations, and a CLI layer that handles sending a task from the user's client to a specific API endpoint. The typicall task signal flow in DivBase looks like the following, starting from the user input:</p>
<p><img alt="Celery Task Implementation Sequence Diagram" src="../../assets/diagrams/celery_task_implementation_sequence_diagram.svg" /></p>
<p>Figure 1: Sequence diagram of the task signal flow in DivBase. Note that this diagram only shows submission and execution of tasks; to fetch the result of a task, users need to use the task history CLI command, which is not included in this diagram. Please see <a href="../task_history_implementation/">Task History Implementation</a> for details on that command.</p>
<h2 id="2-implementation-of-user-submitted-tasks">2. Implementation of user-submitted tasks<a class="headerlink" href="#2-implementation-of-user-submitted-tasks" title="Permanent link">&para;</a></h2>
<p>For a user-submitted task to be fully integrated in DivBase, it needs to be implemented in five different layers, as described in the subsections below. Doing so ensures that the task can be enqued and executed in the job system, and ensures that the task results can be correctly returned to the user with the task history CLI command.</p>
<h3 id="21-task-definition">2.1 Task Definition<a class="headerlink" href="#21-task-definition" title="Permanent link">&para;</a></h3>
<ul>
<li>Tasks are defined in <code>./packages/divbase-api/src/divbase_api/worker/tasks.py</code></li>
<li>Towards the top of the file are the Celery app defintions in <code>app = Celery()</code> and <code>app.conf.update()</code>. These should not be altered unless refactoring the celery app specifically. The Celery results backend handles writing of task metadata to the <code>CeleryTaskMeta</code> table in the postgreSQL database.</li>
<li>Two Celery signal handlers are used to write to additional postgreSQL tables to capture values that are not included in <code>CeleryTaskMeta</code>. Like the Celery app, these should not be altered unless they are part of a refactoring.</li>
<li>The <code>after_task_publish</code> signal handler handles cron jobs specifically. This signal fires when a task is published to the queue. If the task name begins with <code>cron_task</code> an entry is written to <code>TaskHistoryDB</code>. For user-submitted tasks, the writes to <code>TaskHistoryDB</code> are handled by the API, as described below in Section 2.3.</li>
<li>The <code>task_prerun</code> signal handler fires when an idle worker picks up a task from the queue and changes its status to <code>STARTED</code>. This signal triggeres a write of a <code>started_at</code> timestamp to the <code>TaskStartedAtDB</code> table. This is used by the task history logic to calculate the runtime of a task.</li>
<li>A user-submitted task in DivBase is a function decorated with <code>@app.task(tasks.&lt;NAME&gt;)</code>. It is possible to tag the tasks with labels, such as <code>tags=["slow"]</code>. These tags could potentially be used by other Celery logic, such as task routing, but the use of tags is optional in DivBase tasks.</li>
<li>For clarity, suffix the function name with <code>_task</code>, e.g. <code>def &lt;FUNCTION_NAME&gt;_task()</code>. There is no logic that uses the suffix, so its function is to signal to the developer that this is a task function.</li>
<li>Define the task arguments and their type hints just like any other Python function. There are no mandatory args for DivBase tasks, but there are some patterns that can be reused. For instance, if the task logic will interact with S3, add <code>bucket_name: str,</code> Tasks that interact with VCF dimensions table need <code>project_id: int,</code> for the <code>get_vcf_metadata_by_project()</code> helper function and <code>project_name: str,</code> for exceptions.</li>
<li>The logic inside the task can be anything, but typically include reading file(s) from S3 and acting on them.</li>
<li>Divbase tasks can include database transaction (see next bullet below for more details), but if the task only does a database CRUD it would be better to implement that as an async database CRUD in the API layer rather than a Celery task since that is likely faster and does not require a Celery worker.</li>
<li>There are existing helper functions for S3 operations (e.g. <code>create_s3_file_manager()</code>, <code>_download_vcf_files()</code>, <code>_delete_job_files_from_worker()</code>) and VCF dimensions metadata table transactions (e.g. <code>get_vcf_metadata_by_project()</code>, <code>get_skipped_vcfs_by_project_worker()</code>,<code>create_or_update_vcf_metadata()</code>). Look at previous tasks to see if there are existing helper functions or logic that can be reused.</li>
<li>Database transactions can be called from the task using the <code>SyncSessionLocal()</code> sessionmaker instance from SQLAlchemy. There is no point in trying to use async database sessions in DivBase Celery tasks since tasks are run in dedicated worker containers/pods and inside a Celery event pool (see the Celery docs for <code>prefork</code> pools). Furthermore, since Celery does not provide a simple way to use the async event loops from SQLAlchemy. Experiments during DivBase development showed that it is technically possible to implement workarounds to use async db sessions in tasks executed by Celery workers, but that it can easily result in event pool issues and errors.</li>
<li>Raise errors in the task function (catching any errors proprageted from potential helper fuctions called by the task). This assures that <code>CeleryTaskMeta</code> is correctly updated with task status <code>FAILURE</code> and the error message. This assures that the task history CLI command correctly prints this information in the user's terminal. If errors are returned in any other way that with a <code>raise</code>, there is a risk that the status of the task becomes <code>SUCESS</code> even if it exited due to errors.</li>
<li>Tasks end with a <code>return</code> statement. This is written to the <code>results</code> field in <code>CeleryTaskMeta</code>. Celery will use <code>pickle</code> to serialize the results for storage in the <code>CeleryTaskMeta</code> table.</li>
<li>For best compatibility, return a dictionary containing e.g. messages and values from the task.</li>
<li>Note! Celery cannot handle serialisation of Pydantic models so they cannot be directlty in the return. It is possible to have a helper function return a Pydantic model to the task, but then this needs to be dumped to Python dict with <code>&lt;PYDANTIC_MODEL_NAME&gt;.model_dump()</code>.</li>
<li>Perhaps a little unintutive given the last subbullet above, but DivBase task input and outputs should preferrably be structured as Pydantic models since this gives benefits elsewhere in the codebase. Details on this is covered in Section 2.2.</li>
<li>Dynamtic task routing is optional</li>
</ul>
<p>Example of a task defintion:</p>
<div class="highlight"><pre><span></span><code><span id="__span-0-1"><span class="c1"># This assumes that this is in tasks.py and that the celery app is defined somewhere above this example function</span>
</span><span id="__span-0-2">
</span><span id="__span-0-3"><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;tasks.example&quot;</span><span class="p">)</span>
</span><span id="__span-0-4"><span class="k">def</span><span class="w"> </span><span class="nf">example_task</span><span class="p">(</span>
</span><span id="__span-0-5">    <span class="n">my_input_parameter</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-6">    <span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-7">    <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-0-8">    <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-0-9"><span class="p">):</span>
</span><span id="__span-0-10">
</span><span id="__span-0-11"><span class="c1"># To get the Celery Task UUID, for instance for logging and error messages, use:</span>
</span><span id="__span-0-12"><span class="n">task_id</span> <span class="o">=</span> <span class="n">example_task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span>
</span><span id="__span-0-13"><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting bcftools_pipe_task with Celery, task ID: </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-0-14">
</span><span id="__span-0-15"><span class="c1"># Example of how to add database transactions to a task by using the sync database session:</span>
</span><span id="__span-0-16"><span class="k">with</span> <span class="n">SyncSessionLocal</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-0-17">    <span class="n">vcf_dimensions_data</span> <span class="o">=</span> <span class="n">get_vcf_metadata_by_project</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
</span><span id="__span-0-18">
</span><span id="__span-0-19"><span class="c1"># Raise errors inside the task to ensure that the task is masked as FAILED in CeleryTaskMeta.</span>
</span><span id="__span-0-20"><span class="c1"># Some custom exceptions exist that can take variables such as project name or task UUID</span>
</span><span id="__span-0-21"><span class="k">if</span> <span class="ow">not</span> <span class="n">vcf_dimensions_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vcf_files&quot;</span><span class="p">):</span>
</span><span id="__span-0-22">    <span class="k">raise</span> <span class="n">VCFDimensionsEntryMissingError</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">)</span>
</span><span id="__span-0-23">
</span><span id="__span-0-24"><span class="c1"># Add any logic that the task should perform,</span>
</span><span id="__span-0-25"><span class="n">calculated_value</span> <span class="o">=</span> <span class="n">my_function</span><span class="p">(</span><span class="n">my_input_parameter</span><span class="p">)</span>
</span><span id="__span-0-26">
</span><span id="__span-0-27"><span class="c1"># The returns should preferrably be a dict (or a Pydantic model dump) to be compatible with Celery serilisation</span>
</span><span id="__span-0-28"><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">:</span> <span class="n">calculated_value</span><span class="p">}</span>
</span></code></pre></div>
<p>For a longer example, please look at <code>bcftools_pipe_task()</code> in <code>tasks.py</code>. The other examples in this document will refer to aspects of <code>bcftools_pipe_task()</code>, but for brevity, a toy task was used here instead.</p>
<h3 id="22-pydantic-models">2.2. Pydantic models<a class="headerlink" href="#22-pydantic-models" title="Permanent link">&para;</a></h3>
<p>DivBase use Pydantic models for strong typing, type validation, and as self-documenting data structures. Support for Pydantic model validation comes out-of-the-box with fastAPI, which is the API service used in DivBase. As described in Section 2,1, the Celery task itself cannot return Pydantic models (this is a limiation of Celery). Other than that, Pydantic models are used for all requests and responses to/from the API, including when users submit tasks and request task history to/from the DivBase server.</p>
<p>In DivBase, Pydantic models are used together with Celery tasks in the following way:</p>
<ul>
<li>In the folder in <code>./packages/divbase-lib/src/divbase_lib/api_schemas/</code>, add a request model (send from the CLI to the API), a task kwargs model (send by the API to Celery), and a response model for the task results (used when returning task results with the task history CLI command).</li>
<li>Also register those models in <code>TaskHistoryResult</code> Pydantic mdoel in <code>./packages/divbase-lib/src/divbase_lib/api_schemas/task_history.py</code> so that they are correctly returned to the user when the run the task history CLI command. Place request and results models in a relevant schema file within the api_schemas (e.g., <code>queries.py</code>, <code>vcf_dimensions.py</code>, or a new one with a name of your choice).</li>
</ul>
<p>Example of a request, task kwargs, and results model for a task named BcftoolsQuery:</p>
<div class="highlight"><pre><span></span><code><span id="__span-1-1"><span class="k">class</span><span class="w"> </span><span class="nc">BcftoolsQueryRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Request model for sample metadata query route.&quot;&quot;&quot;</span>
</span><span id="__span-1-3">
</span><span id="__span-1-4">    <span class="n">tsv_filter</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-5">    <span class="n">metadata_tsv_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-6">    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-7">
</span><span id="__span-1-8">
</span><span id="__span-1-9"><span class="k">class</span><span class="w"> </span><span class="nc">BcftoolsQueryKwargs</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-10"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Keyword arguments for BCFtools query task. Used to pass info to Celery task, and also for recording task history.&quot;&quot;&quot;</span>
</span><span id="__span-1-11">
</span><span id="__span-1-12">    <span class="n">tsv_filter</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-13">    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-14">    <span class="n">metadata_tsv_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-15">    <span class="n">bucket_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-16">    <span class="n">project_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-1-17">    <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-18">    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-1-19">
</span><span id="__span-1-20">
</span><span id="__span-1-21"><span class="k">class</span><span class="w"> </span><span class="nc">BcftoolsQueryTaskResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-1-22"><span class="w">    </span><span class="sd">&quot;&quot;&quot;BCFtools query task result details. Based on the return of tasks.bcftools_query.&quot;&quot;&quot;</span>
</span><span id="__span-1-23">
</span><span id="__span-1-24">    <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-1-25">    <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></code></pre></div>
<p>And then add the task kwargs and task results models TaskHistoryResult in <code>./packages/divbase-lib/src/divbase_lib/api_schemas/task_history.py</code>:</p>
<div class="highlight"><pre><span></span><code><span id="__span-2-1"><span class="k">class</span><span class="w"> </span><span class="nc">TaskHistoryResult</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-2"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-3"><span class="sd">    Task details as returned by queries to the SQAlchemy+pg results backend.</span>
</span><span id="__span-2-4"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-5">
</span><span id="__span-2-6">    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-2-7">    <span class="n">submitter_email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-8">    <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-9">    <span class="n">result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-2-10">        <span class="n">Union</span><span class="p">[</span>
</span><span id="__span-2-11">            <span class="nb">dict</span><span class="p">[</span>
</span><span id="__span-2-12">                <span class="nb">str</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-2-13">            <span class="p">],</span>  <span class="c1"># Note! This dict must come first here so that error results are preserved and not incorrectly inserted into the result models</span>
</span><span id="__span-2-14">            <span class="n">SampleMetadataQueryTaskResult</span><span class="p">,</span>
</span><span id="__span-2-15">            <span class="n">BcftoolsQueryTaskResult</span><span class="p">,</span> <span class="c1"># Task result model from above example</span>
</span><span id="__span-2-16">            <span class="n">DimensionUpdateTaskResult</span><span class="p">,</span>
</span><span id="__span-2-17">        <span class="p">]</span>
</span><span id="__span-2-18">    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-19">    <span class="n">date_done</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-20">    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-21">    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-22">    <span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="__span-2-23">        <span class="n">Union</span><span class="p">[</span>
</span><span id="__span-2-24">            <span class="n">SampleMetadataQueryKwargs</span><span class="p">,</span>
</span><span id="__span-2-25">            <span class="n">BcftoolsQueryKwargs</span><span class="p">,</span> <span class="c1"># Task kwargs model from above example</span>
</span><span id="__span-2-26">            <span class="n">DimensionUpdateKwargs</span><span class="p">,</span>
</span><span id="__span-2-27">        <span class="p">]</span>
</span><span id="__span-2-28">    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-29">    <span class="n">worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-30">    <span class="n">created_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-31">    <span class="n">started_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-32">    <span class="n">completed_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-33">    <span class="n">runtime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></code></pre></div>
<h3 id="23-api-endpoint">2.3. API endpoint<a class="headerlink" href="#23-api-endpoint" title="Permanent link">&para;</a></h3>
<ul>
<li>API endpoints for enqueueing tasks are found in files the folder: <code>./packages/divbase-api/src/divbase_api/routes/</code></li>
<li>Endpoint functions are decorated on the form <code>@query_router.post("&lt;ENDPOINT_URL&gt;", status_code=status.HTTP_201_CREATED)</code>, where <code>&lt;ENDPOINT_URL&gt;</code> should be a RESTful URL such as <code>/bcftools-pipe/projects/{project_name}</code></li>
<li>To make use of fastAPIs async worker threads, define the function as<code>async def &lt;ENDPOINT_FUNCTION_NAME&gt;()</code></li>
<li>The endpoint function has several required arguments: the Pydantic Request model (see Section 2.2.) and three helper arguments / fastAPI dependency injections. The Pydantic model is used to convert the incoming payload into the model and validate its types (see Section 2.4 for how the CLI uses and serializes the same Pydantic model in the request).</li>
</ul>
<p><code>python
 async def my_endpoint_function(
    my_request_model: MyRequestModel,
    project_name: str,
    project_and_user_and_role: tuple[ProjectDB, UserDB, ProjectRoles] = Depends(get_project_member),
    db: AsyncSession = Depends(get_db),
 )</code></p>
<ul>
<li>The dependency injection in <code>project_and_user_and_role</code> and the helper function <code>has_required_role</code> are used to connect to the database and check that the user has permission to submit tasks to this project. See the example below for how to use it in an endpoint function.</li>
<li>To enqueue the task function defined in <code>tasks.py</code> in the job system, use <code>result = &lt;TASK_FUNCTION&gt;.apply_async()</code>. This returns some initial Celery task metadata, including the Celery task UUID.</li>
<li>The established pattern in DivBase is - for clarity - to call <code>.apply_async()</code> with keyword arguments and not arguments. Specifically, the Pydantic kwargs model can be populated, and then dumped in to Python dict in <code>.apply_async()</code> since Celery cannot de/serialise Pydantic mdoels. This ensures that kwarg types are validated before enqueuing the task.</li>
<li>Call the <code>create_task_history_entry()</code> CRUD function to record the Celery task UUID in <code>TaskHistoryDB</code> along with user and project ID. This function will return the DivBase task ID, which is the autoincrementing id from the postgreSQL table. This is an integer and much easier for the users to handle than long UUIDs.</li>
<li>Finally, return the DivBase task ID to the user client as an API reponse.</li>
</ul>
<p>Example of an API endpoint. This pattern can more or less be used as boilerplate code when creating new endpoints for user-submitted tasks.</p>
<div class="highlight"><pre><span></span><code><span id="__span-3-1"><span class="nd">@query_router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/bcftools-pipe/projects/</span><span class="si">{project_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
</span><span id="__span-3-2"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_bcftools_jobs</span><span class="p">(</span>
</span><span id="__span-3-3">    <span class="n">bcftools_query_request</span><span class="p">:</span> <span class="n">BcftoolsQueryRequest</span><span class="p">,</span>
</span><span id="__span-3-4">    <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-3-5">    <span class="n">project_and_user_and_role</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ProjectDB</span><span class="p">,</span> <span class="n">UserDB</span><span class="p">,</span> <span class="n">ProjectRoles</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_project_member</span><span class="p">),</span>
</span><span id="__span-3-6">    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db</span><span class="p">),</span>
</span><span id="__span-3-7"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="__span-3-8"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-3-9"><span class="sd">    Create a new bcftools query job for the specified project.</span>
</span><span id="__span-3-10"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-3-11">    <span class="c1"># Standard DivBase pattern to check if user has permission to submit a task to a specific project.</span>
</span><span id="__span-3-12">    <span class="c1"># First calls a helper function that makes a lookup of user credentials in the database.</span>
</span><span id="__span-3-13">    <span class="c1"># Assumes that the CLI sent the request using make_authenticated_request(), see Section 2.4.</span>
</span><span id="__span-3-14">    <span class="n">project</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">role</span> <span class="o">=</span> <span class="n">project_and_user_and_role</span>
</span><span id="__span-3-15">    <span class="c1"># Then calls on another helper function to check if the credentials are enough to grant permission</span>
</span><span id="__span-3-16">    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_required_role</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">ProjectRoles</span><span class="o">.</span><span class="n">EDIT</span><span class="p">):</span>
</span><span id="__span-3-17">        <span class="k">raise</span> <span class="n">AuthorizationError</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have permission to query this project.&quot;</span><span class="p">)</span>
</span><span id="__span-3-18">
</span><span id="__span-3-19">    <span class="c1"># Pack the required task arguments in the corresponding Pydantic model (see Section 2.2.)</span>
</span><span id="__span-3-20">    <span class="c1"># This ensures that the kwargs are type validated</span>
</span><span id="__span-3-21">    <span class="n">task_kwargs</span> <span class="o">=</span> <span class="n">BcftoolsQueryKwargs</span><span class="p">(</span>
</span><span id="__span-3-22">        <span class="n">tsv_filter</span><span class="o">=</span><span class="n">bcftools_query_request</span><span class="o">.</span><span class="n">tsv_filter</span><span class="p">,</span>
</span><span id="__span-3-23">        <span class="n">command</span><span class="o">=</span><span class="n">bcftools_query_request</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
</span><span id="__span-3-24">        <span class="n">metadata_tsv_name</span><span class="o">=</span><span class="n">bcftools_query_request</span><span class="o">.</span><span class="n">metadata_tsv_name</span><span class="p">,</span>
</span><span id="__span-3-25">        <span class="n">bucket_name</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
</span><span id="__span-3-26">        <span class="n">project_id</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-3-27">        <span class="n">project_name</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-3-28">    <span class="p">)</span>
</span><span id="__span-3-29">
</span><span id="__span-3-30">    <span class="c1"># Send the task to the Celery app, which enqueues it in the job system broker.</span>
</span><span id="__span-3-31">    <span class="c1"># Note that the kwargs Pydantic model is dumped already here. This is due to a limitation in Celery&#39;s deserialization. It may seem redundant, but this way the the kwarg types have been validated by Pydantic.</span>
</span><span id="__span-3-32">    <span class="n">results</span> <span class="o">=</span> <span class="n">bcftools_pipe_task</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="n">task_kwargs</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
</span><span id="__span-3-33">
</span><span id="__span-3-34">    <span class="c1"># Call a helper CRUD function to create an entry in TaskHistoryDB that maps Celery Task UUID,</span>
</span><span id="__span-3-35">    <span class="c1"># User_id, and project_id. The auto-incremented table id is returned. This will now serve as</span>
</span><span id="__span-3-36">    <span class="c1"># the DivBase task ID, since it it an int and less unwieldy than a full UUID.</span>
</span><span id="__span-3-37">    <span class="n">job_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_task_history_entry</span><span class="p">(</span>
</span><span id="__span-3-38">        <span class="n">user_id</span><span class="o">=</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-3-39">        <span class="n">project_id</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-3-40">        <span class="n">task_id</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="__span-3-41">        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="__span-3-42">    <span class="p">)</span>
</span><span id="__span-3-43">
</span><span id="__span-3-44">    <span class="c1"># As a API response, return the DivBase task ID to the CLI client that made the request, where it can be displayed to the user.</span>
</span><span id="__span-3-45">    <span class="k">return</span> <span class="n">job_id</span>
</span></code></pre></div>
<p>Note on a special case: if a task returns is return result directly from the API endpoint (currently, only implemented in <code>sample_metadata_query_task()</code> since it is considered to be a very quick task), the endpoint decorator can contain the Pydantic results model (see Section 2.2.) as <code>response_model=SampleMetadataQueryTaskResult</code>. If used this way, fastAPI will validate the model before returning it, and raise an error if the returned data structure does not match the types of the Pydantic model.</p>
<div class="highlight"><pre><span></span><code><span id="__span-4-1"><span class="nd">@query_router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-4-2">    <span class="s2">&quot;/sample-metadata/projects/</span><span class="si">{project_name}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-4-3">    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">,</span>
</span><span id="__span-4-4">    <span class="n">response_model</span><span class="o">=</span><span class="n">SampleMetadataQueryTaskResult</span><span class="p">,</span>
</span><span id="__span-4-5"><span class="p">)</span>
</span></code></pre></div>
<h3 id="24-cli">2.4. CLI<a class="headerlink" href="#24-cli" title="Permanent link">&para;</a></h3>
<p>The DivBase client uses the <a href="https://typer.tiangolo.com/">Typer</a> library to build its CLI. This part of the docs will not explain how the DivBase Typer architechture was setup, but will focus on adding a new CLI command to submit a task to the DivBase server.</p>
<ul>
<li>The CLI commands are defined in files in the folder <code>./packages/divbase-cli/src/divbase_cli/cli_commands/</code>. The CLI commands make requests to the API and gets responses back. For task-submitting requests, the CLI commands send task args to the corresponding API endpoint based on the user's CLI input.</li>
<li>There needs to be a Typer app (on the form <code>query_app = typer.Typer()</code>) to which the CLI command functions needs to be connected. The app needs to be initiated with <code>app.add_typer(query_app, name="query")</code> in <code>./packages/divbase-cli/src/divbase_cli/divbase_cli.py</code>.</li>
<li>The typer app name is used as a decorator for the function, e.g. <code>@query_app.command("bcftools-pipe")</code>. The argument of the decorator will become the command for the CLI.</li>
<li>Pack the task arguments in the Pydantic request model (see Section 2.2), e.g. <code>request_data=BcftoolsQueryRequest()</code> for type validation.</li>
<li>The <code>resolve_project()</code> helper function is be used to fetch the data from the users local config and is needed for the established pattern to make the request. This helper function need that the CLI function args contain <code>project: str | None = PROJECT_NAME_OPTION,</code> and <code>config_file: Path = CONFIG_FILE_OPTION,</code>. See an existing CLI file for more details on the constants they are calling.</li>
<li>The main function call for all DivBase CLI-&gt;API interactions is <code>make_authenticated_request()</code>. If the user is logged in to the CLI, it sends the user's JSON Web Token as part of the request, which the API uses to validate the user's identity and project role/permissions.</li>
<li>The arguments <code>method="POST",divbase_base_url=project_config.divbase_url</code> should always be included as is.</li>
<li><code>api_route</code> is the route URL defined in the corresponding endpoint (see Section 2.3).</li>
<li><code>json=request_data.model_dump()</code> is used to serialise the Pydantic model to Python dict so that it can be passed as JSON in the request payload. The API endpoint will take this input and pack it back into the corresponding Pydantic model if everthing has been configured as described in Section 2.3.</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span id="__span-5-1"><span class="c1"># Define a Typer app</span>
</span><span id="__span-5-2"><span class="n">query_app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">(</span>
</span><span id="__span-5-3">    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run queries on the VCF files stored in the project&#39;s storage bucket. Queries are run on the DivBase API&quot;</span><span class="p">,</span>
</span><span id="__span-5-4">    <span class="n">no_args_is_help</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-5-5"><span class="p">)</span>
</span><span id="__span-5-6">
</span><span id="__span-5-7">
</span><span id="__span-5-8"><span class="nd">@query_app</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;bcftools-pipe&quot;</span><span class="p">)</span>
</span><span id="__span-5-9"><span class="k">def</span><span class="w"> </span><span class="nf">pipe_query</span><span class="p">(</span>
</span><span id="__span-5-10">    <span class="n">tsv_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">TSV_FILTER_HELP_TEXT</span><span class="p">),</span>
</span><span id="__span-5-11">    <span class="n">command</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">BCFTOOLS_ARGUMENT</span><span class="p">,</span>
</span><span id="__span-5-12">    <span class="n">metadata_tsv_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">METADATA_TSV_ARGUMENT</span><span class="p">,</span>
</span><span id="__span-5-13">    <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">PROJECT_NAME_OPTION</span><span class="p">,</span>
</span><span id="__span-5-14">    <span class="n">config_file</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">CONFIG_FILE_OPTION</span><span class="p">,</span>
</span><span id="__span-5-15"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-16"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-5-17"><span class="sd">    Submit a query to run on the DivBase API. A single, merged VCF file will be added to the project&#39;s storage bucket on success.</span>
</span><span id="__span-5-18"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-5-19">    <span class="c1"># Helper function that fetches project information from the users local config file</span>
</span><span id="__span-5-20">    <span class="n">project_config</span> <span class="o">=</span> <span class="n">resolve_project</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="n">config_file</span><span class="p">)</span>
</span><span id="__span-5-21">
</span><span id="__span-5-22">    <span class="c1"># Pack the required task arguments in the corresponding Pydantic model (see Section 2.2.)</span>
</span><span id="__span-5-23">    <span class="c1"># This ensures that the kwargs are type validated</span>
</span><span id="__span-5-24">    <span class="n">request_data</span> <span class="o">=</span> <span class="n">BcftoolsQueryRequest</span><span class="p">(</span><span class="n">tsv_filter</span><span class="o">=</span><span class="n">tsv_filter</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">metadata_tsv_name</span><span class="o">=</span><span class="n">metadata_tsv_name</span><span class="p">)</span>
</span><span id="__span-5-25">
</span><span id="__span-5-26">    <span class="c1"># Call an helper function to send a request to the API. If the user is logged in to the CLI,</span>
</span><span id="__span-5-27">    <span class="c1"># the function passes a JWT token to the API that is used to verify the user&#39;s identity and permissions</span>
</span><span id="__span-5-28">    <span class="n">response</span> <span class="o">=</span> <span class="n">make_authenticated_request</span><span class="p">(</span>
</span><span id="__span-5-29">        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="__span-5-30">        <span class="n">divbase_base_url</span><span class="o">=</span><span class="n">project_config</span><span class="o">.</span><span class="n">divbase_url</span><span class="p">,</span>
</span><span id="__span-5-31">        <span class="n">api_route</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;v1/query/bcftools-pipe/projects/</span><span class="si">{</span><span class="n">project_config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-5-32">        <span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span> <span class="c1"># serialize the Pydantic model to Python dict since the API expects JSON. On the API side, it converted back to the Pydantic model.</span>
</span><span id="__span-5-33">    <span class="p">)</span>
</span><span id="__span-5-34">
</span><span id="__span-5-35">    <span class="c1"># Using the pattern described in Section 2.3, the API returns the DivBase task ID, which can be displayed to the user in their terminal like such:</span>
</span><span id="__span-5-36">    <span class="n">task_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-5-37">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job submitted successfully with task id: </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="25-task-history-deserialization">2.5. Task History deserialization<a class="headerlink" href="#25-task-history-deserialization" title="Permanent link">&para;</a></h3>
<p>The steps covered in Sections 2.1-2.4 are enough to implement tasks that can be submitted and executed. But in order to fetch the results from task, it the task history deserialiser also need to be updated to contain the kwargs and results Pydantic models from the task.</p>
<ul>
<li>The deserialiser is located in <code>./packages/divbase-api/src/divbase_api/services/task_history.py</code>.</li>
<li>Update <code>_deserialize_celery_task_metadata</code> to handle your new tasks result and kwargs schemas.</li>
<li>Under the <code>else:</code> clause shown in the below example, add an if statement with the name of the task <code>if task_name ==&lt;TASK_NAME&gt;</code>, where <code>&lt;TASK_NAME&gt;</code> is the name that was defined in the task decorator in Section 2.1. E.g. <code>if task_name ==tasks.bcftools_query</code>, referring to the task name defined in <code>@app.task(tasks.bcftools_query)</code>.</li>
<li>In the if statement, specify the results and kwargs models of the tasks using:</li>
</ul>
<div class="highlight"><pre><span></span><code><span id="__span-6-1">parsed_result = &lt;TASK_RESULTS_PYDANTIC_MODEL&gt;(**result_data) if result_data else None
</span><span id="__span-6-2">parsed_kwargs = &lt;TASK_KWARGS_PYDANTIC_MODEL&gt;(**kwargs) if kwargs else None
</span></code></pre></div>
<ul>
<li>By following these patterns, the task history deserialiser should now be able to correctly deserialise and inser the task metadata into the <code>TaskHistoryResults</code> model for return to the user.</li>
<li>The Starlette-admin panel is already configured for deserialisation of the task history results using its own logic. It does not rely on Pydantic models in the same way that the task history CLI does, and therefore no additions are needed to be made in (<code>./packages/divbase-api/src/divbase_api/admin_panel.py</code>).</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span id="__span-7-1"><span class="k">def</span><span class="w"> </span><span class="nf">_deserialize_celery_task_metadata</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TaskHistoryResult</span><span class="p">:</span>
</span><span id="__span-7-2">
</span><span id="__span-7-3"><span class="c1"># ... Scroll down to this section of the function</span>
</span><span id="__span-7-4">
</span><span id="__span-7-5"><span class="n">is_error_result</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="__span-7-6">        <span class="s2">&quot;exc_type&quot;</span> <span class="ow">in</span> <span class="n">result_data</span> <span class="ow">or</span> <span class="s2">&quot;exc_message&quot;</span> <span class="ow">in</span> <span class="n">result_data</span> <span class="ow">or</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span>
</span><span id="__span-7-7">    <span class="p">)</span>
</span><span id="__span-7-8">    <span class="k">if</span> <span class="n">is_error_result</span><span class="p">:</span>
</span><span id="__span-7-9">        <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">result_data</span>
</span><span id="__span-7-10">        <span class="n">parsed_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="__span-7-11">    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-12">        <span class="k">if</span> <span class="n">task_name</span> <span class="o">==</span> <span class="s2">&quot;tasks.sample_metadata_query&quot;</span><span class="p">:</span>
</span><span id="__span-7-13">            <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">SampleMetadataQueryTaskResult</span><span class="p">(</span><span class="o">**</span><span class="n">result_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">result_data</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-14">            <span class="n">parsed_kwargs</span> <span class="o">=</span> <span class="n">SampleMetadataQueryKwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-15">        <span class="k">elif</span> <span class="n">task_name</span> <span class="o">==</span> <span class="s2">&quot;tasks.bcftools_query&quot;</span><span class="p">:</span>
</span><span id="__span-7-16">            <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">BcftoolsQueryTaskResult</span><span class="p">(</span><span class="o">**</span><span class="n">result_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">result_data</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-17">            <span class="n">parsed_kwargs</span> <span class="o">=</span> <span class="n">BcftoolsQueryKwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-18">        <span class="k">elif</span> <span class="n">task_name</span> <span class="o">==</span> <span class="s2">&quot;tasks.update_vcf_dimensions_task&quot;</span><span class="p">:</span>
</span><span id="__span-7-19">            <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">DimensionUpdateTaskResult</span><span class="p">(</span><span class="o">**</span><span class="n">result_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">result_data</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-20">            <span class="n">parsed_kwargs</span> <span class="o">=</span> <span class="n">DimensionUpdateKwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-7-21">        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-7-22">            <span class="c1"># Fallback for Unknown task type - keep everything as dicts</span>
</span><span id="__span-7-23">            <span class="n">parsed_result</span> <span class="o">=</span> <span class="n">result_data</span>
</span><span id="__span-7-24">            <span class="n">parsed_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="__span-7-25">
</span><span id="__span-7-26"><span class="c1"># ... Code continues, does not need to be updated</span>
</span></code></pre></div>
<h2 id="3-implementation-of-system-submitted-periodic-cron-tasks">3. Implementation of system-submitted periodic (cron) tasks<a class="headerlink" href="#3-implementation-of-system-submitted-periodic-cron-tasks" title="Permanent link">&para;</a></h2>
<p>DivBase uses Celery Beat for periodic tasks to schedule certain system operations. This for instance include cleanup of dangling task history entries in the database and other jobs that relate to interal states of the system components (often the PostgreSQL database). Note that system deployment level periodic tasks, such as database backup, is NOT handled by the Celery Beat tasks. This text will use the concept cron task, (Celery) Beat task, and periodic task interchangably.</p>
<ul>
<li>The tasks are defined in <code>./packages/divbase-api/src/divbase_api/worker/cron_tasks.py</code> to separate them from the user-submitted tasks. A small workaround is needed to make this work: at the bottom of <code>tasks.py</code> is an import statement for the cron tasks as <code>from divbase_api.worker import cron_tasks  # noqa: E402, F401</code>. This needs to come at the bottom to avoid issues with Celery app initiation timings and circular imports and should never need to be altered unless during a refactoring.</li>
<li>Celery Beat needs to be enabled in the Celery app or a specific worker container. Please refer to the <a href="https://docs.celeryq.dev/en/main/userguide/periodic-tasks.html#starting-the-scheduler">Celery doc</a>. This is already configured for the DivBase Docker Compose stack used for local dev, but may need to configured differently for deployment to a cluster environment.</li>
<li>Because of this setup, the cron tasks can be decorated with reference to same Celery app as the user-submitted tasks. Add <code>@app.task(name="cron_tasks.&lt;NAME&gt;")</code> above the task function definition like before. NOTE! In DivBase, it is important that the periodic task names are prefixed by <code>cron_tasks.</code>: there is logic in the signal handlers that make use of this; also it give a clear distinction from the user-submitted tasks that start with <code>task.</code></li>
<li>The Beat tasks are configured to writes to the three task history tables (<code>TaskHistoryDB</code>, <code>TaskStartedAtDB</code>, <code>CeleryTaskMeta</code>) just like the user-submitted tasks. Since these tasks are intended for internal use, their task metadata can only be viewed from the Starlette-admin panel and not from the task history CLI command.</li>
<li>The write to <code>TaskHistoryDB</code> is handled by the <code>@after_task_publish</code> Celery signal handler in <code>tasks.py</code>. For comparison, user-submitted tasks are writted to <code>TaskHistoryDB</code> by the API and returns the DivBase task ID. The cron task does not use neither the API nor the DivBase task ID, and thus this signal handler that fires when the task is enqueued in the broker is used instead. (Technically, all Celery tasks will trigger the <code>@after_task_publish</code> function, but only tasks with a name that starts with <code>cron_task.</code> will be processed by the function logic.) To further mark that the task belongs to the system and not to any user, the signal handler ensures that the inserted row in <code>TaskHistoryDB</code> will use <code>user_id=None, project_id=None</code>.</li>
<li>The other two tables are written to with the same logic as for the user-submitted tasks: when the task starts, the <code>@task_prerun</code> signal will write to <code>TaskStartedAtDB</code>, and the Celery results backend will write to <code>CeleryTaskMeta</code> during task execution.</li>
<li>Definiton of the actualy task logic work just like described in Section 2.1. E.g. connect to databse with SyncSessionLocal() if needed, raise exception in the main task, return result messages, etc.</li>
<li>The main difference compared to the user-submitted tasks is that the cron tasks are scheduled to submitted to the Celery queue with <code>app.conf.beat_schedule</code>. This is a nested dictionary in which the frequency and arguments for a cron task is configured.</li>
<li>The frequency is set with <code>crontab</code>. See the <a href="https://docs.celeryq.dev/en/main/userguide/periodic-tasks.html#crontab-schedules">Celery docs on periodic tasks</a> for more details.</li>
</ul>
<p>Example of a DivBase cron task definition:</p>
<div class="highlight"><pre><span></span><code><span id="__span-8-1"><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cron_tasks.cleanup_old_task_history&quot;</span><span class="p">)</span>
</span><span id="__span-8-2"><span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_task_history_task</span><span class="p">(</span><span class="n">retention_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">TASK_RETENTION_DAYS</span><span class="p">):</span>
</span><span id="__span-8-3"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-8-4"><span class="sd">    Periodic task to clean up old task history entries from both TaskHistoryDB and CeleryTaskMeta.</span>
</span><span id="__span-8-5"><span class="sd">    Runs daily to remove entries older than retention_days.</span>
</span><span id="__span-8-6"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-8-7">    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-8-8">        <span class="n">cutoff_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">retention_days</span><span class="p">)</span>
</span><span id="__span-8-9">
</span><span id="__span-8-10">        <span class="k">with</span> <span class="n">SyncSessionLocal</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
</span><span id="__span-8-11">            <span class="n">old_task_ids</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-8-12">                <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-8-13">                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-8-14">                    <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT task_id FROM task_history WHERE created_at &lt; :cutoff_date&quot;</span><span class="p">),</span>
</span><span id="__span-8-15">                    <span class="p">{</span><span class="s2">&quot;cutoff_date&quot;</span><span class="p">:</span> <span class="n">cutoff_date</span><span class="p">},</span>
</span><span id="__span-8-16">                <span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span><span id="__span-8-17">            <span class="p">]</span>
</span><span id="__span-8-18">
</span><span id="__span-8-19">            <span class="n">deleted_celery_task_meta</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-8-20">                <span class="n">delete</span><span class="p">(</span><span class="n">CeleryTaskMeta</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">CeleryTaskMeta</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">old_task_ids</span><span class="p">))</span>
</span><span id="__span-8-21">            <span class="p">)</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="__span-8-22">            <span class="n">deleted_task_history</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-8-23">                <span class="n">delete</span><span class="p">(</span><span class="n">TaskHistoryDB</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TaskHistoryDB</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">old_task_ids</span><span class="p">))</span>
</span><span id="__span-8-24">            <span class="p">)</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="__span-8-25">            <span class="n">deleted_started_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="__span-8-26">                <span class="n">delete</span><span class="p">(</span><span class="n">TaskStartedAtDB</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">TaskStartedAtDB</span><span class="o">.</span><span class="n">task_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">old_task_ids</span><span class="p">))</span>
</span><span id="__span-8-27">            <span class="p">)</span><span class="o">.</span><span class="n">rowcount</span>
</span><span id="__span-8-28">
</span><span id="__span-8-29">            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="__span-8-30">
</span><span id="__span-8-31">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-8-32">                <span class="sa">f</span><span class="s2">&quot;Cleaned up </span><span class="si">{</span><span class="n">deleted_celery_task_meta</span><span class="si">}</span><span class="s2"> entries from CeleryTaskMeta, &quot;</span>
</span><span id="__span-8-33">                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">deleted_task_history</span><span class="si">}</span><span class="s2"> from TaskHistoryDB, and &quot;</span>
</span><span id="__span-8-34">                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">deleted_started_at</span><span class="si">}</span><span class="s2"> from TaskStartedAtDB older than </span><span class="si">{</span><span class="n">retention_days</span><span class="si">}</span><span class="s2"> days &quot;</span>
</span><span id="__span-8-35">                <span class="sa">f</span><span class="s2">&quot;(cutoff: </span><span class="si">{</span><span class="n">cutoff_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="__span-8-36">            <span class="p">)</span>
</span><span id="__span-8-37">
</span><span id="__span-8-38">            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-8-39">                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
</span><span id="__span-8-40">                <span class="s2">&quot;number_of_celery_meta_deleted&quot;</span><span class="p">:</span> <span class="n">deleted_celery_task_meta</span><span class="p">,</span>
</span><span id="__span-8-41">                <span class="s2">&quot;number_of_task_history_deleted&quot;</span><span class="p">:</span> <span class="n">deleted_task_history</span><span class="p">,</span>
</span><span id="__span-8-42">                <span class="s2">&quot;number_of_started_at_deleted&quot;</span><span class="p">:</span> <span class="n">deleted_started_at</span><span class="p">,</span>
</span><span id="__span-8-43">                <span class="s2">&quot;cutoff_date&quot;</span><span class="p">:</span> <span class="n">cutoff_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="__span-8-44">                <span class="s2">&quot;retention_days&quot;</span><span class="p">:</span> <span class="n">retention_days</span><span class="p">,</span>
</span><span id="__span-8-45">            <span class="p">}</span>
</span><span id="__span-8-46">
</span><span id="__span-8-47">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-8-48">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to cleanup old task history: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-8-49">        <span class="k">raise</span>
</span></code></pre></div>
<p>Example of how a <code>app.conf.beat_schedule</code> configuration:</p>
<div class="highlight"><pre><span></span><code><span id="__span-9-1"><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">beat_schedule</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-9-2">    <span class="s2">&quot;cleanup-old-tasks-daily&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-3">        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;cron_tasks.cleanup_old_task_history&quot;</span><span class="p">,</span>
</span><span id="__span-9-4">        <span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span>
</span><span id="__span-9-5">            <span class="n">hour</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span>
</span><span id="__span-9-6">        <span class="p">),</span>  <span class="c1"># Run daily at 5 AM CET (timezone defined in app in tasks.py). Don&#39;t set to 2 AM or 3 AM due to daylight saving</span>
</span><span id="__span-9-7">        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;retention_days&quot;</span><span class="p">:</span> <span class="n">TASK_RETENTION_DAYS</span><span class="p">},</span>
</span><span id="__span-9-8">    <span class="p">},</span>
</span><span id="__span-9-9">    <span class="s2">&quot;cleanup-stuck-tasks-daily&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-10">        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;cron_tasks.cleanup_stuck_tasks&quot;</span><span class="p">,</span>
</span><span id="__span-9-11">        <span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span>
</span><span id="__span-9-12">            <span class="n">hour</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">15</span>
</span><span id="__span-9-13">        <span class="p">),</span>  <span class="c1"># Run daily at 5:15 AM CET (timezone defined in app in tasks.py). Don&#39;t set to 2 AM or 3 AM due to daylight saving</span>
</span><span id="__span-9-14">        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-9-15">            <span class="s2">&quot;stuck_pending_hours&quot;</span><span class="p">:</span> <span class="n">STUCK_PENDING_STATUS_HOURS</span><span class="p">,</span>
</span><span id="__span-9-16">            <span class="s2">&quot;stuck_started_hours&quot;</span><span class="p">:</span> <span class="n">STUCK_STARTED_STATUS_HOURS</span><span class="p">,</span>
</span><span id="__span-9-17">        <span class="p">},</span>
</span><span id="__span-9-18">    <span class="p">},</span>
</span><span id="__span-9-19"><span class="p">}</span>
</span></code></pre></div>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../database-migrations/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Database Migrations">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Database Migrations
              </div>
            </div>
          </a>
        
        
          
          <a href="../bcftools_task_logic/" class="md-footer__link md-footer__link--next" aria-label="Next: Bcftools Celery Task Logic">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Bcftools Celery Task Logic
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ScilifelabDataCentre/divbase" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M202.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M496 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
    
    
    
    
    <a href="https://divbase.scilifelab.se" target="_blank" rel="noopener" title="Website" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M351.9 280H161c2.9 64.5 17.2 123.9 37.5 167.4 11.4 24.5 23.7 41.8 35.1 52.4 11.2 10.5 18.9 12.2 22.9 12.2s11.7-1.7 22.9-12.2c11.4-10.6 23.7-28 35.1-52.4 20.3-43.5 34.6-102.9 37.5-167.4zm-191-48h190.9c-2.8-64.5-17.1-123.9-37.4-167.4-11.4-24.4-23.7-41.8-35.1-52.4C268.1 1.7 260.4 0 256.4 0s-11.7 1.7-22.9 12.2c-11.4 10.6-23.7 28-35.1 52.4-20.3 43.5-34.6 102.9-37.5 167.4m-48 0c3.5-85.6 25.6-165.1 57.9-217.3C78.7 47.3 10.9 131.2 1.5 232zM1.5 280c9.4 100.8 77.2 184.7 169.3 217.3-32.3-52.2-54.4-131.7-57.9-217.3zm398.4 0c-3.5 85.6-25.6 165.1-57.9 217.3 92.1-32.7 159.9-116.5 169.3-217.3zm111.4-48C501.9 131.2 434.1 47.3 342 14.7c32.3 52.2 54.4 131.7 57.9 217.3z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.expand", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>